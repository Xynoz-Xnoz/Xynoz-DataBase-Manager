<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xynoz DataBase Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: { 'blob': 'blob 10s infinite' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        
        @keyframes float-slow { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-20px) rotate(5deg); } }
        @keyframes float-slower { 0%, 100% { transform: translateY(0px) translateX(0px) rotate(0deg); } 50% { transform: translateY(15px) translateX(10px) rotate(-5deg); } }
        @keyframes float-reverse { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(20px) rotate(-3deg); } }

        .animate-float-slow { animation: float-slow 15s ease-in-out infinite; }
        .animate-float-slower { animation: float-slower 20s ease-in-out infinite; }
        .animate-float-reverse { animation: float-reverse 18s ease-in-out infinite; }

        .bg-icon { position: absolute; color: rgba(148, 163, 184, 0.15); z-index: 0; pointer-events: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid #fff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); position: relative; z-index: 10; }
        
        .badge-owner { background: #ede9fe; color: #7c3aed; border: 1px solid #ddd6fe; }
        .badge-partner { background: #dbeafe; color: #2563eb; border: 1px solid #bfdbfe; }
        .badge-reseller { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }
    </style>
</head>
<body class="min-h-screen py-6 px-4 md:py-10 text-slate-800 relative overflow-x-hidden flex flex-col">

    <div class="fixed inset-0 w-full h-full overflow-hidden pointer-events-none">
        <i class="fab fa-js bg-icon text-5xl md:text-7xl top-5 left-5 animate-float-slow"></i>
        <i class="fab fa-python bg-icon text-4xl md:text-6xl top-32 left-1/4 animate-float-reverse"></i>
        <i class="fab fa-react bg-icon text-5xl md:text-7xl top-20 right-5 md:right-20 animate-float-slower"></i>
        <i class="fab fa-node-js bg-icon text-4xl md:text-5xl top-40 right-[30%] animate-float-slow"></i>
        <i class="fab fa-html5 bg-icon text-4xl md:text-6xl bottom-20 left-5 md:left-20 animate-float-slower"></i>
        <i class="fab fa-css3-alt bg-icon text-3xl md:text-5xl bottom-10 left-[40%] animate-float-reverse"></i>
        <i class="fab fa-docker bg-icon text-5xl md:text-7xl bottom-20 right-5 animate-float-slow"></i>
    </div>

    <div class="fixed inset-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-0 left-1/4 w-64 h-64 md:w-96 md:h-96 bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob"></div>
        <div class="absolute bottom-0 right-1/4 w-64 h-64 md:w-96 md:h-96 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob animation-delay-2000"></div>
    </div>

    <header class="max-w-5xl mx-auto w-full mb-6 flex flex-col md:flex-row justify-between items-center glass-panel p-4 md:p-6 rounded-2xl gap-4">
        <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="w-10 h-10 md:w-12 md:h-12 bg-slate-900 rounded-xl flex items-center justify-center text-white text-lg md:text-xl shadow-lg shrink-0">
                <i class="fas fa-database"></i>
            </div>
            <div>
                <h1 class="text-lg md:text-xl font-bold">Xynoz DataBase Manager</h1>
                <p class="text-xs text-slate-500 capitalize flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="font-bold text-indigo-600 uppercase" id="displayRole">User</span>
                </p>
            </div>
        </div>
        
        <div class="flex gap-2 w-full md:w-auto justify-end flex-wrap">
            <button onclick="openListUserModal()" id="btnListUser" class="hidden flex-1 md:flex-none bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition shadow-sm whitespace-nowrap">
                <i class="fas fa-users mr-1 md:mr-2"></i> Data User
            </button>
            <button onclick="openUserModal()" id="btnCreateUser" class="hidden flex-1 md:flex-none bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition shadow-md whitespace-nowrap">
                <i class="fas fa-user-plus mr-1 md:mr-2"></i> Buat Akun
            </button>
            <button onclick="logout()" class="bg-white hover:bg-red-50 text-red-500 border border-slate-200 px-3 py-2 rounded-lg text-xs md:text-sm font-bold transition">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <main class="max-w-5xl mx-auto w-full grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">
        <div class="lg:col-span-1 glass-panel p-4 md:p-6 rounded-2xl h-fit">
            <h2 class="font-bold mb-4 flex items-center gap-2 text-slate-700 text-sm md:text-base">
                <i class="fas fa-key text-indigo-500"></i> Input Token
            </h2>
            <div class="space-y-3">
                <input type="text" id="tokenInput" placeholder="Paste bot token..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all">
                <button onclick="addToken()" id="btnSaveToken" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-xs md:text-sm hover:bg-slate-800 shadow-md active:scale-95 transition-all">
                    SIMPAN KE DATABASE
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 glass-panel p-4 md:p-6 rounded-2xl h-[450px] md:h-[500px] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-100">
                <h2 class="font-bold text-slate-700 flex items-center gap-2 text-sm md:text-base">
                    <i class="fas fa-list text-indigo-500"></i> Token Aktif
                    <span id="tokenCount" class="bg-indigo-50 text-indigo-600 text-xs px-2 py-1 rounded-full border border-indigo-100">0</span>
                </h2>
                <button onclick="loadTokens()" class="w-8 h-8 rounded-lg hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-indigo-600 transition-all">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i>
                </button>
            </div>
            <div class="flex-1 overflow-hidden relative">
                <div id="tokenList" class="absolute inset-0 overflow-y-auto pr-1 space-y-2 pb-2"></div>
            </div>
        </div>
    </main>

    <footer class="w-full text-center py-6 mt-4 text-slate-500 text-xs font-medium opacity-80 z-10 relative">
        &copy; 2026 Xynoz Dev - Xynoz DataBase Manager
    </footer>

    <div id="userModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end md:items-center justify-center backdrop-blur-sm sm:p-4">
        <div class="bg-white w-full md:max-w-sm p-6 rounded-t-2xl md:rounded-2xl shadow-2xl transition-transform duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800">Buat Akun Baru</h3>
                <button onclick="closeUserModal()" class="text-slate-400 hover:text-red-500 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Username</label>
                    <input type="text" id="newUsername" class="w-full p-3 border rounded-xl bg-slate-50 outline-none focus:border-indigo-500 text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Password</label>
                    <input type="text" id="newPassword" class="w-full p-3 border rounded-xl bg-slate-50 outline-none focus:border-indigo-500 text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Role Akses</label>
                    <select id="newRole" class="w-full p-3 border rounded-xl bg-slate-50 outline-none focus:border-indigo-500 text-slate-700 text-sm"></select>
                </div>
                <button onclick="createNewUser()" id="btnCreate" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl hover:bg-indigo-700 mt-2 shadow-lg active:scale-95 transition-all text-sm">
                    BUAT USER
                </button>
            </div>
        </div>
    </div>

    <div id="listUserModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full md:max-w-md p-6 rounded-2xl shadow-2xl h-[500px] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-users text-indigo-500"></i> Daftar Pengguna</h3>
                <button onclick="closeListUserModal()" class="text-slate-400 hover:text-red-500 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-hidden relative">
                <div id="userListContainer" class="absolute inset-0 overflow-y-auto pr-2 space-y-3">
                    <div class="text-center text-slate-400 mt-10"><i class="fas fa-spinner fa-spin"></i> Memuat data...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="setting.js"></script>
    <script>
        if (!localStorage.getItem('isLoggedIn')) window.location.href = 'login.html';
        const userRole = localStorage.getItem('role');
        const currentUsername = localStorage.getItem('username');
        document.getElementById('displayRole').innerText = userRole;

        if (userRole === 'owner' || userRole === 'partner') {
            document.getElementById('btnCreateUser').classList.remove('hidden');
            document.getElementById('btnListUser').classList.remove('hidden');
        }

        function openUserModal() {
            const modal = document.getElementById('userModal');
            const roleSelect = document.getElementById('newRole');
            modal.classList.remove('hidden');
            roleSelect.innerHTML = ''; 
            if (userRole === 'owner') {
                roleSelect.innerHTML = `<option value="reseller">Reseller</option><option value="partner">Partner</option><option value="owner">Owner</option>`;
            } else if (userRole === 'partner') {
                roleSelect.innerHTML = `<option value="reseller">Reseller</option>`;
            }
        }
        function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); }

        function openListUserModal() {
            document.getElementById('listUserModal').classList.remove('hidden');
            fetchAndRenderUsers();
        }
        function closeListUserModal() { document.getElementById('listUserModal').classList.add('hidden'); }

        async function fetchAndRenderUsers() {
            const container = document.getElementById('userListContainer');
            try {
                const url = getApiUrl(CONFIG.USER_FILE);
                const res = await axios.get(url + '?t=' + Date.now(), { headers: { Authorization: `token ${CONFIG.TOKEN}` } });
                let users = JSON.parse(atob(res.data.content));

                const rolePriority = { owner: 1, partner: 2, reseller: 3 };
                users.sort((a, b) => rolePriority[a.role] - rolePriority[b.role]);

                if (users.length === 0) {
                    container.innerHTML = `<div class="text-center text-slate-400 mt-10">Tidak ada user</div>`;
                    return;
                }

                container.innerHTML = users.map(u => {
                    let badgeClass = u.role === 'owner' ? 'badge-owner' : (u.role === 'partner' ? 'badge-partner' : 'badge-reseller');
                    
                    let canDelete = false;
                    if (userRole === 'owner' && u.username !== currentUsername) canDelete = true;
                    if (userRole === 'partner' && u.role === 'reseller') canDelete = true;

                    return `
                        <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <div>
                                <div class="font-bold text-slate-700 text-sm flex items-center gap-2">
                                    ${u.username}
                                    ${u.username === currentUsername ? '<span class="text-[10px] bg-slate-200 px-1 rounded text-slate-500">(You)</span>' : ''}
                                </div>
                                <span class="text-[10px] px-2 py-0.5 rounded-full uppercase font-bold tracking-wide mt-1 inline-block ${badgeClass}">
                                    ${u.role}
                                </span>
                            </div>
                            ${canDelete ? `
                                <button onclick="deleteUser('${u.username}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 transition-all">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');

            } catch (e) {
                container.innerHTML = `<div class="text-center text-red-400 mt-10">Gagal memuat data</div>`;
            }
        }

        async function deleteUser(targetUsername) {
            if(!confirm(`Hapus user "${targetUsername}"?`)) return;
            const container = document.getElementById('userListContainer');
            container.innerHTML = '<div class="text-center text-slate-400 mt-10"><i class="fas fa-spinner fa-spin"></i> Menghapus...</div>';

            try {
                const url = getApiUrl(CONFIG.USER_FILE);
                const res = await axios.get(url, { headers: { Authorization: `token ${CONFIG.TOKEN}` } });
                let users = JSON.parse(atob(res.data.content));

                users = users.filter(u => u.username !== targetUsername);

                await axios.put(url, {
                    message: `Delete User: ${targetUsername}`,
                    content: btoa(JSON.stringify(users, null, 2)),
                    sha: res.data.sha
                }, { headers: { Authorization: `token ${CONFIG.TOKEN}` } });

                fetchAndRenderUsers();
            } catch (e) {
                alert("Gagal menghapus user: " + e.message);
                fetchAndRenderUsers();
            }
        }

        async function createNewUser() {
            const u = document.getElementById('newUsername').value.trim();
            const p = document.getElementById('newPassword').value.trim();
            const r = document.getElementById('newRole').value;
            const btn = document.getElementById('btnCreate');

            if (!u || !p) return alert("Isi Data Lengkap!");
            btn.innerText = "Menyimpan..."; btn.disabled = true;

            try {
                const url = getApiUrl(CONFIG.USER_FILE);
                const res = await axios.get(url, { headers: { Authorization: `token ${CONFIG.TOKEN}` } });
                let users = JSON.parse(atob(res.data.content));

                if (users.find(x => x.username === u)) throw new Error("Username sudah ada!");
                users.push({ username: u, password: p, role: r });

                await axios.put(url, {
                    message: `Add ${r}: ${u}`,
                    content: btoa(JSON.stringify(users, null, 2)),
                    sha: res.data.sha
                }, { headers: { Authorization: `token ${CONFIG.TOKEN}` } });

                alert("Sukses!");
                closeUserModal();
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
            } catch (err) { alert(err.message); } 
            finally { btn.innerText = "BUAT USER"; btn.disabled = false; }
        }

        async function loadTokens() {
            const list = document.getElementById('tokenList');
            const count = document.getElementById('tokenCount');
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('fa-spin');
            try {
                const url = getApiUrl(CONFIG.DB_FILE);
                const res = await axios.get(url + '?t=' + Date.now(), { headers: { Authorization: `token ${CONFIG.TOKEN}` } });
                const content = JSON.parse(atob(res.data.content));
                const tokens = content.tokens || [];
                count.innerText = tokens.length;
                if(tokens.length === 0) {
                    list.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-400 opacity-50"><i class="fas fa-folder-open text-3xl mb-2"></i><p class="text-xs">Kosong</p></div>`;
                } else {
                    list.innerHTML = tokens.map(t => `
                        <div class="flex justify-between items-center bg-white hover:bg-indigo-50 p-3 rounded-xl border border-slate-100 hover:border-indigo-100 transition-all shadow-sm group">
                            <code class="text-xs text-slate-600 font-mono truncate w-3/4 select-all">${t}</code>
                            <button onclick="deleteToken('${t}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 transition-all md:opacity-0 group-hover:opacity-100">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                }
            } catch (e) { list.innerHTML = `<div class="text-center text-red-400 mt-4 text-xs">Gagal memuat data</div>`; }
            finally { icon.classList.remove('fa-spin'); }
        }
        async function addToken() {
            const input = document.getElementById('tokenInput');
            const val = input.value.trim();
            const btn = document.getElementById('btnSaveToken');
            if(!val) return alert("Token kosong!");
            btn.innerText = "MENYIMPAN..."; btn.disabled = true;
            try {
                const url = getApiUrl(CONFIG.DB_FILE);
                const res = await axios.get(url, { headers: { Authorization: `token ${CONFIG.TOKEN}` } });
                let data = JSON.parse(atob(res.data.content));
                if(data.tokens.includes(val)) return alert("Token sudah ada!");
                data.tokens.push(val);
                await axios.put(url, {
                    message: "Add Token via Web",
                    content: btoa(JSON.stringify(data, null, 2)),
                    sha: res.data.sha
                }, { headers: { Authorization: `token ${CONFIG.TOKEN}` } });
                input.value = '';
                loadTokens();
            } catch(e) { alert(e.message); }
            finally { btn.innerText = "SIMPAN KE DATABASE"; btn.disabled = false; }
        }
        async function deleteToken(val) {
            if(!confirm("Hapus token ini?")) return;
            try {
                const url = getApiUrl(CONFIG.DB_FILE);
                const res = await axios.get(url, { headers: { Authorization: `token ${CONFIG.TOKEN}` } });
                let data = JSON.parse(atob(res.data.content));
                data.tokens = data.tokens.filter(t => t !== val);
                await axios.put(url, {
                    message: "Del Token via Web",
                    content: btoa(JSON.stringify(data, null, 2)),
                    sha: res.data.sha
                }, { headers: { Authorization: `token ${CONFIG.TOKEN}` } });
                loadTokens();
            } catch(e) { alert("Gagal hapus"); }
        }
        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
        window.onload = loadTokens;
    </script>
</body>
</html>
